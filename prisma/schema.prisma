generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// üè¢ Capa Corporativa (Tenants)
model Tenant {
  id             String      @id @default(uuid())
  ruc            String      @unique
  razonSocial    String
  sector         String
  portalName     String
  primaryColor   String      @default("#1152d4")
  logoUrl        String?
  biometricsOn   Boolean     @default(false)
  signatureOn    Boolean     @default(false)
  arcoOn         Boolean     @default(false)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  
  staff          StaffUser[]
  identities     DigitalIdentity[]
  auditLogs      AuditChain[]
}

// üßë‚Äçüíº Usuario Administrativo (Quien hace login)
model StaffUser {
  id           String    @id @default(uuid())
  tenantId     String
  email        String    @unique
  passwordHash String    // Hashed password (bcrypt)
  name         String?   // Nombre del usuario
  image        String?   // Url del avatar
  role         String    @default("ADMIN") // OWNER, ADMIN, AUDITOR - Ojo: Enum en lugar de String es mejor pero string es flexible
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant       Tenant    @relation(fields: [tenantId], references: [id])
}

// üë• Capa de Identidad Digital
model DigitalIdentity {
  id             String   @id @default(uuid())
  tenantId       String
  fullName       String
  idNumber       String
  email          String?  // Contacto para ARCO/Notificaciones
  phone          String?
  biometricToken String?  // Representaci√≥n cifrada del perfil
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  consentEvents  ConsentEvent[]
  signatureContracts SignatureContract[]
  arcoRequests   ArcoRequest[]
}

model ConsentEvent {
  id         String   @id @default(uuid())
  identityId String
  purpose    String
  status     String   // ACCEPTED, REVOKED
  ipAddress  String?
  timestamp  DateTime @default(now())

  identity   DigitalIdentity @relation(fields: [identityId], references: [id])
}

// üîê Capa de M√≥dulos Operativos
model SignatureContract {
  id            String    @id @default(uuid())
  identityId    String
  fileName      String
  fileUrl       String
  fileHash      String?
  status        String    @default("PENDING")
  expiresAt     DateTime?
  signatureHash String?
  signedAt      DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  identity      DigitalIdentity @relation(fields: [identityId], references: [id])
}

model ArcoRequest {
  id         String   @id @default(uuid())
  identityId   String
  type         String   // ACCESO, RECTIFICACION, etc.
  description  String?  // Detalles de la solicitud
  contactEmail    String?
  contactPhone    String?
  status          String    @default("PENDING")
  resolution      String?   // Detalles de la resoluci√≥n
  rejectionReason String?   // Motivo de rechazo si aplica
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  identity   DigitalIdentity @relation(fields: [identityId], references: [id])
}

// üìú Capa de Integridad (Immutable logs)
model AuditChain {
  id           String   @id @default(uuid())
  tenantId     String
  eventType    String
  payload      Json     // Datos del evento
  metadata     Json?    // Metadatos (IP, UserAgent)
  payloadHash  String
  prevHash     String?
  combinedHash String
  timestamp    DateTime @default(now())

  tenant       Tenant   @relation(fields: [tenantId], references: [id])
}
